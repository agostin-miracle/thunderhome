


CREATE PROCEDURE PRREGCRTCALMEN
(
   @CODCRT INT,
   @UPDUSU INT
)

AS
	DECLARE @USUPRO INT
	DECLARE @ASSUSU INT
	DECLARE @USUMEN INT 
	DECLARE @DATATV DATETIME
	DECLARE @DATVCT DATETIME  /* DATA DE VENCIMENTO DO CARTAO */
	DECLARE @VALCRT VARCHAR(10) 
	DECLARE @APLMEN BIT = 0
	DECLARE @VLRMEN MONEY =0
	DECLARE @CODUSU INT = 0;
	DECLARE @USRREF INT = 0;
	/* USUARIO CONFIGURACAO */
	DECLARE @APLM1 BIT = 0
	DECLARE @VLRM1 MONEY =0
	DECLARE @APLM2 BIT = 0
	DECLARE @VLRM2 MONEY =0
	DECLARE @RETURN_VALUE INT = 0  /* NUMERO DE REGISTROS ADICIONADOS */


	SELECT @USUPRO = USUPRO, 
	       @ASSUSU = @ASSUSU
		   ,@USUMEN = USUMEN
		   ,@DATATV=DATATV
	  FROM TBREGCRT (NOLOCK) 
	 WHERE CODCRT = @CODCRT

	SELECT @VALCRT = VALCRT 
	  FROM TBCADCRT (NOLOCK) 
	 WHERE CODCRT = @CODCRT

	IF(@USUMEN =0)
	    BEGIN
			SET @CODUSU = @ASSUSU
			SET @USRREF = @ASSUSU
	    END
	ELSE
	    BEGIN
			SET @CODUSU = @USUMEN
			SET @USRREF = @ASSUSU
		END

    /* Valor da Mensalidade Gestor */
	SELECT @APLM1 = ISNULL(APLMEN,CAST(0 AS BIT)), @VLRM1 =ISNULL(VLRMEN,0) FROM TBUSUPRO (NOLOCK) WHERE USUPRO=@USUPRO
    /* Valor da Mensalidade Usuário */
	SELECT @APLM2 = ISNULL(APLMEN,CAST(0 AS BIT)), @VLRM2 =ISNULL(VLRMEN,0) FROM TBUSUCFG (NOLOCK) WHERE USUCFG=@CODUSU AND NIVCFG=2

	IF(@APLM1= 0 AND @APLM2=0)
		BEGIN
			UPDATE TBREGCRT SET CALMEN= 9, DATUPD=GETDATE(), UPDUSU=@UPDUSU WHERE CODCRT=@CODCRT
		END
	ELSE
		BEGIN
			DECLARE @USRSET BIT=0
			IF(@APLM2=1 AND @VLRM2 > 0)
				BEGIN
					SET @APLMEN = 1;
					SET @VLRMEN = @VLRM2
					SET @USRSET=1;
				END

			IF(@USRSET=0)
				BEGIN
					SET @APLMEN = 1;
					SET @VLRMEN = @VLRM1
				END
		END


	IF(@APLMEN=1 AND @VLRMEN>0)
		BEGIN
			DECLARE @DATINI DATETIME = @DATATV
			DECLARE @DATFIN DATETIME = dbo.ValidadeCartao(@VALCRT)
			INSERT INTO TBREGMEN (
					STAMEN 
					,NUMMES
					,NUMANO
					,CODUSU
					,USRREF
					,DATMEN 
					,DATVCT
					,TIPMEN
					,NUMPCL
					,USUPRO
					,VLRCOB
					,CODREF
			)
			SELECT STAMEN = 261 
				  ,NUMMNES = MONTH(VALDAT)
				  ,NUMANO = YEAR(VALDAT)
				  ,CODUSU=@CODUSU
				  ,@USRREF
				  ,DATMEN=VALDAT 
				  ,DATVCT=VALDAT
				  ,TIPMEN=1
				  ,NUMPCL=id
				  ,USUPRO=@USUPRO
				  ,VLRCOB=@VLRMEN
				  ,@CODCRT
	 		  FROM dbo.ExpandPeriod(@DATATV, @DATVCT)
			  WHERE  RIGHT('00' + CAST(MONTH(TIPMEN) AS VARCHAR),2)+
			         RIGHT('00' + CAST(MONTH(VALDAT) AS VARCHAR),2)+
		             RIGHT('0000' + CAST(YEAR(VALDAT) AS VARCHAR),4) +
                     RIGHT('00000000' + CAST(@CODCRT AS VARCHAR),2) + '1'  NOT IN (SELECT  
                     RIGHT('00' + CAST(TIPMEN AS VARCHAR),2)+
                     RIGHT('00' + CAST(NUMMES AS VARCHAR),2)+
                     RIGHT('0000' + CAST(NUMANO AS VARCHAR),4) +
                     RIGHT('00000000' + CAST(CODREF AS VARCHAR),2)+
					 CAST(MODREG AS VARCHAR(1))  FROM TBREGMEN)
              SET @RETURN_VALUE = @@ROWCOUNT

			  IF(@RETURN_VALUE>0)
				BEGIN
					UPDATE TBREGCRT SET CALMEN= 2, DATUPD=GETDATE(), UPDUSU=@UPDUSU WHERE CODCRT=@CODCRT
				END

			  	
		END
   
		RETURN @RETURN_VALUE


