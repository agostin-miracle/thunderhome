
IF OBJECT_ID ( 'dbo.PRGETNXTNUM', 'P' ) IS NOT NULL
    DROP PROCEDURE dbo.PRGETNXTNUM;
GO


CREATE PROCEDURE [dbo].[PRGETNXTNUM]
(
	@CODTBI Integer
)
AS
	/*
		 
	*/

    SET NOCOUNT ON
	DECLARE @RETURN_VALUE INT =0
	IF( NOT EXISTS(SELECT 1 FROM TBNXTNUM WHERE CODTBI = @CODTBI))
		BEGIN
			INSERT INTO TBNXTNUM (CODTBI, NUMNXT) VALUES(@CODTBI, 1)
			SET @RETURN_VALUE=1;
		END
	ELSE 
	    SELECT @RETURN_VALUE = ISNULL(NUMNXT,0) FROM TBNXTNUM (NOLOCK)  WHERE CODTBI = @CODTBI
	UPDATE TBNXTNUM WITH (UPDLOCK) SET NUMNXT = (@RETURN_VALUE+1) WHERE CODTBI = @CODTBI
	RETURN @RETURN_VALUE;
GO



IF OBJECT_ID ( 'dbo.SPK_CREATECODIFIEDKEY', 'P' ) IS NOT NULL
    DROP PROCEDURE dbo.SPK_CREATECODIFIEDKEY;
GO


create proc [dbo].[SPK_CREATECODIFIEDKEY](
	@TEXT_VALUE varchar(100), 
	@CODIFIED  VARCHAR(100) OUTPUT)
as
	SET NOCOUNT ON
	DECLARE @KEY_VALUE varchar(8)
	DECLARE @CHANGE_KEY_CHAR int
	DECLARE @result varchar(200)
	SET @result=N'';
	DECLARE @tmp varchar(2)
	SET @KEY_VALUE ='19650415'
	SET @CHANGE_KEY_CHAR = Cast(SUBSTRING(@KEY_VALUE,1,2) AS INT)
	DECLARE @LEN_OF_TEXT int
	DECLARE @INITIAL_POS int
	SET @INITIAL_POS = 1
	SET @LEN_OF_TEXT = len(@TEXT_VALUE)
	While (@INITIAL_POS<=@LEN_OF_TEXT)
		Begin
			SET @tmp = SUBSTRING(@TEXT_VALUE, @INITIAL_POS,1)
			SET @result = @result + @tmp
			if(@INITIAL_POS <= len(@KEY_VALUE))
				begin
					SET @tmp = SUBSTRING(@KEY_VALUE, @INITIAL_POS,1)
					SET @result = @result + @tmp
				end
			else
			begin
				SET @result = @result + '('
			end
			SET @INITIAL_POS = @INITIAL_POS + 1
		End
	SET @result = Reverse(@result)
	SET @INITIAL_POS = 1
	SET @LEN_OF_TEXT = len(@result)
	SET @TEXT_VALUE = @result
	SET @result = N'' 
	While (@INITIAL_POS<=@LEN_OF_TEXT)
		Begin
			SET @tmp = SUBSTRING(@TEXT_VALUE, @INITIAL_POS,1)
			SET @result = @result + CHAR(ASCII(@tmp)+ @CHANGE_KEY_CHAR)
			SET @INITIAL_POS = @INITIAL_POS + 1
		End
	SET @CODIFIED=@RESULT
	RETURN

GO

IF OBJECT_ID ( 'dbo.SPK_CREATEDECODIFIEDKEY', 'P' ) IS NOT NULL
    DROP PROCEDURE dbo.SPK_CREATEDECODIFIEDKEY;
GO

create proc [dbo].[SPK_CREATEDECODIFIEDKEY](
	@TEXT_VALUE varchar(100),
	@DECODIFIED  VARCHAR(100) OUTPUT)
as
	SET NOCOUNT ON
	DECLARE @KEY_VALUE varchar(8)
	DECLARE @CHANGE_KEY_CHAR int
	DECLARE @result varchar(200)
	SET @result=N'';
	DECLARE @tmp varchar(2)
	SET @KEY_VALUE ='19650415'
	SET @CHANGE_KEY_CHAR = Cast(SUBSTRING(@KEY_VALUE,1,2) AS INT)

	DECLARE @LEN_OF_TEXT int
	DECLARE @INITIAL_POS int
	SET @INITIAL_POS = 1
	--SET @TEXT_VALUE = REVERSE(@TEXT_VALUE)
	SET @LEN_OF_TEXT = len(@TEXT_VALUE)
	While (@INITIAL_POS<=@LEN_OF_TEXT)
		Begin
			SET @tmp = SUBSTRING(@TEXT_VALUE, @INITIAL_POS,1)
			SET @result = @result + CHAR(ASCII(@tmp)- @CHANGE_KEY_CHAR)
			SET @INITIAL_POS = @INITIAL_POS + 1
		End
	SET @RESULT = REVERSE(@RESULT)
	SET @TEXT_VALUE = @RESULT
	SET @RESULT = N''
	SET @INITIAL_POS = 1
	SET @LEN_OF_TEXT = len(@TEXT_VALUE)
	DECLARE @fator int
	While (@INITIAL_POS<=@LEN_OF_TEXT)
		Begin
			SET @tmp = SUBSTRING(@TEXT_VALUE, @INITIAL_POS,1)
			SET @fator = @INITIAL_POS % 2
			if (@fator<>0)
				Begin
					SET @result = @result + @tmp
				end
			SET @INITIAL_POS = @INITIAL_POS + 1
		End
	SET @DECODIFIED=@RESULT
	RETURN

GO